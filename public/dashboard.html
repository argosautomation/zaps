<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaps.ai | Admin Dashboard</title>
    <link rel="icon" type="image/png" href="/admin/favicon.png">
    <link rel="stylesheet" href="/admin/css/style.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Zaps<span class="highlight">.ai</span></h2>
                <small>Gateway v1.1.1</small>
            </div>

            <nav>
                <a href="#stats" class="nav-link active" onclick="switchTab('stats')">üìä Overview</a>
                <a href="#providers" class="nav-link" onclick="switchTab('providers')">üîå Providers</a>
                <a href="#keys" class="nav-link" onclick="switchTab('keys')">üîë API Keys</a>
                <a href="#whitelist" class="nav-link" onclick="switchTab('whitelist')">üõ°Ô∏è IP Whitelist</a>
                <a href="#docs" class="nav-link" onclick="switchTab('docs')">üìö Documentation</a>
                <a href="#users" class="nav-link" onclick="switchTab('users')">üë• Users</a>
            </nav>

            <div class="user-info">
                <div>
                    <small>Logged in as</small><br>
                    <strong id="currentUser">...</strong>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Stats View -->
            <div id="view-stats" class="view-section">
                <h1>Overview</h1>
                <div class="grid-cols-2" style="margin-top: 1rem;">
                    <div class="card">
                        <h2>System Status <span class="status-badge">Healthy</span></h2>
                        <p>Gateway is active and processing requests.</p>
                        <br>
                        <div>
                            <strong>Uptime:</strong> 99.9%<br>
                            <strong>DeepSeek API:</strong> Configured<br>
                            <strong>Redaction:</strong> Active
                        </div>
                    </div>
                    <div class="card">
                        <h2>Quick Actions</h2>
                        <button class="btn-primary btn-sm" onclick="switchTab('keys')">+ Generate New API Key</button>
                        <br>
                        <button class="btn-secondary btn-sm" onclick="switchTab('docs')">View Integration Guide</button>
                    </div>
                </div>
            </div>

            <!-- Providers View -->
            <div id="view-providers" class="view-section" style="display: none;">
                <div class="card">
                    <h2>üîå LLM Configuration</h2>
                    <p>Enter your API keys for the providers you wish to use. These are stored securely and encrypted.
                    </p>

                    <form onsubmit="saveProviders(event)" style="margin-top: 1.5rem;">
                        <div class="input-group">
                            <label>OpenAI API Key (for gpt-4o, etc)</label>
                            <input type="password" id="prov-openai" placeholder="sk-..." autocomplete="off">
                        </div>

                        <div class="input-group">
                            <label>DeepSeek API Key (for deepseek-chat)</label>
                            <input type="password" id="prov-deepseek" placeholder="sk-..." autocomplete="off">
                        </div>

                        <div class="input-group">
                            <label>Anthropic API Key (for claude-3-5)</label>
                            <input type="password" id="prov-anthropic" placeholder="sk-..." autocomplete="off">
                        </div>

                        <div style="margin-top: 2rem;">
                            <button class="btn-primary">Save Configuration</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- API Keys View -->
            <div id="view-keys" class="view-section" style="display: none;">
                <div class="card">
                    <h2>API Credentials <button class="btn-primary btn-sm" onclick="openKeyModal()">+ New
                            Key</button></h2>
                    <table id="keysTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Prefix</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                            <tr>
                                <td colspan="5" style="text-align: center;">Loading keys...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Whitelist View -->
            <div id="view-whitelist" class="view-section" style="display: none;">
                <div class="card">
                    <h2>Allowed IP Addresses <button class="btn-primary btn-sm" onclick="openIpModal()">+ Add
                            IP</button></h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Only IPs listed here can access this
                        Admin Dashboard.</p>
                    <table id="whitelistTable">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Label</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Docs View -->
            <div id="view-docs" class="view-section" style="display: none;">
                <div class="card">
                    <h1>Zaps.ai Gateway - API Authentication Guide</h1>

                    <h3>‚úÖ Authentication is ENABLED</h3>
                    <p>The gateway now requires a valid API key for all requests to <code>/v1/chat/completions</code>.
                    </p>

                    <h3>üõ°Ô∏è Automatic PII Redaction</h3>
                    <p>The gateway acts as an intelligent privacy shield between your application and the LLM
                        (DeepSeek). It automatically detects and redacts sensitive data <strong>before</strong> it
                        leaves your infrastructure.</p>

                    <h4>Protected Data types:</h4>
                    <ul style="margin-left: 1.5rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        <li><strong>Contact Info:</strong> Email addresses, Phone numbers</li>
                        <li><strong>Financial:</strong> Credit Card numbers, IBANs, Crypto addresses</li>
                        <li><strong>Secrets:</strong> OpenAI Keys, AWS Credentials, GitHub Tokens, Stripe Keys</li>
                        <li><strong>Personal:</strong> US Social Security Numbers (SSN)</li>
                    </ul>

                    <p>When the LLM responds, the gateway <strong>rehydrates</strong> the original data, so your
                        application receives the correct information transparently. The AI never sees the raw secrets.
                    </p>

                    <hr>

                    <h3>üîë API Key Format</h3>
                    <p>All API keys start with <code>gk_</code> followed by a 32-character random string:<br>
                        Example: <code>gk_x37x-a_xBS9uFO90YP8m3omAXQHIKcMg</code></p>

                    <hr>

                    <h3>üöÄ Using API Keys in Your Application</h3>

                    <div
                        style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.1);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <label style="color: var(--text-secondary);">Select Provider Example:</label>
                            <select id="docProviderSelect" onchange="updateDocs()"
                                style="background: #0f172a; color: white; border: 1px solid #334155; padding: 0.5rem; border-radius: 6px;">
                                <option value="gpt-4o">OpenAI (gpt-4o)</option>
                                <option value="gpt-4-turbo">OpenAI (gpt-4-turbo)</option>
                                <option value="gpt-3.5-turbo">OpenAI (gpt-3.5-turbo)</option>
                                <option value="o1-preview">OpenAI (o1-preview)</option>
                                <option value="o1-mini">OpenAI (o1-mini)</option>
                                <option value="deepseek-chat">DeepSeek (deepseek-chat)</option>
                                <option value="deepseek-reasoner">DeepSeek (deepseek-reasoner)</option>
                                <option value="claude-3-5-sonnet">Anthropic (claude-3-5-sonnet)</option>
                            </select>
                        </div>

                        <h4>JavaScript / Node.js</h4>
                        <pre><code id="code-js">const response = await fetch('https://zaps.ai/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer gk_YOUR_ZAPS_KEY'
  },
  body: JSON.stringify({
    model: 'gpt-4o',
    messages: [{ role: 'user', content: 'Hello OpenAI!' }]
  })
});</code></pre>

                        <h4>Python</h4>
                        <pre><code id="code-py">import requests

response = requests.post('https://zaps.ai/v1/chat/completions',
    headers={
        'Content-Type': 'application/json',
        'Authorization': 'Bearer gk_YOUR_ZAPS_KEY'
    },
    json={
        'model': 'gpt-4o',
        'messages': [{'role': 'user', 'content': 'Hello OpenAI!'}]
    }
)</code></pre>

                        <h4>Curl</h4>
                        <pre><code id="code-curl">curl -X POST https://zaps.ai/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer gk_YOUR_ZAPS_KEY" \
  -d '{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "Hello OpenAI!"}]
  }'</code></pre>
                    </div>

                    <script>
                        function updateDocs() {
                            const selection = document.getElementById('docProviderSelect').value;
                            let model = selection;
                            let msg = 'Hello!';

                            if (selection.startsWith('gpt') || selection.startsWith('o1')) {
                                msg = 'Hello OpenAI!';
                            } else if (selection.startsWith('deepseek')) {
                                msg = 'Hello DeepSeek!';
                            } else if (selection.startsWith('claude')) {
                                msg = 'Hello Claude!';
                            }

                            // Update JS
                            document.getElementById('code-js').innerText = `const response = await fetch('https://zaps.ai/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer gk_YOUR_ZAPS_KEY'
  },
  body: JSON.stringify({
    model: '${model}',
    messages: [{ role: 'user', content: '${msg}' }]
  })
});`;

                            // Update Python
                            document.getElementById('code-py').innerText = `import requests

response = requests.post('https://zaps.ai/v1/chat/completions',
    headers={
        'Content-Type': 'application/json',
        'Authorization': 'Bearer gk_YOUR_ZAPS_KEY'
    },
    json={
        'model': '${model}',
        'messages': [{'role': 'user', 'content': '${msg}'}]
    }
);`;

                            // Update Curl
                            document.getElementById('code-curl').innerText = `curl -X POST https://zaps.ai/v1/chat/completions \\
  -H "Content-Type: application/json" \\
  -H "Authorization: Bearer gk_YOUR_ZAPS_KEY" \\
  -d '{
    "model": '${model}',
    "messages": [{"role": "user", "content": "${msg}"}]
  }'`;
                        }
                    </script>
                </div>
            </div>

            <!-- Users View -->
            <div id="view-users" class="view-section" style="display: none;">
                <div class="card">
                    <h2>Admin Users <button class="btn-primary btn-sm" onclick="modal('createUserModal')">+ Create
                            User</button></h2>
                    <p style="margin-bottom: 1rem;">Manage who can access this dashboard.</p>

                    <table id="usersTable" style="margin-bottom: 2rem;">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>

                    <hr>

                    <form onsubmit="changePassword(event)" style="margin-top: 2rem;">
                        <h3>Change Your Password</h3>
                        <div class="input-group" style="margin-top: 1rem;">
                            <input type="password" id="newPass" placeholder="New Password (min 10 chars)">
                        </div>
                        <button class="btn-primary btn-sm">Update Password</button>
                    </form>
                </div>
            </div>

            <!-- Modals -->
            <div id="createUserModal" class="modal">
                <div class="modal-content">
                    <h3>Create New Admin User</h3>
                    <form onsubmit="createUser(event)">
                        <div class="input-group">
                            <label>Username</label>
                            <input type="text" id="newUsername" required placeholder="johndoe">
                        </div>
                        <div class="input-group">
                            <label>Initial Password (min 10 chars)</label>
                            <input type="text" id="initialPass" required placeholder="TemporaryPassword123!">
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button type="button" class="btn-secondary"
                                onclick="closeModal('createUserModal')">Cancel</button>
                            <button type="submit" class="btn-primary">Create User</button>
                        </div>
                    </form>
                </div>
            </div>
    </div>

    <!-- Create Key Modal -->
    <div id="createKeyModal" class="modal">
        <div class="modal-content">
            <h3>Generate New API Key</h3>
            <form onsubmit="generateKey(event)">
                <div class="input-group">
                    <label>Key Name (e.g. 'Production App')</label>
                    <input type="text" id="keyName" required placeholder="My Key" autocomplete="off">
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn-secondary" onclick="closeModal('createKeyModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Generate Key</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Key Success Modal -->
    <div id="keySuccessModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--success)">Key Generated!</h3>
            <p>Please copy your key now. It will <strong>never</strong> be shown again.</p>

            <div class="input-group" style="margin-top: 1rem;">
                <input type="text" id="newKeyDisplay" readonly onclick="this.select()"
                    style="font-family: monospace; color: var(--accent); font-weight: bold;">
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
                <button type="button" class="btn-primary" onclick="closeModal('keySuccessModal')">I've Copied
                    It</button>
            </div>
        </div>
    </div>

    <!-- Add IP Modal -->
    <div id="addIpModal" class="modal">
        <div class="modal-content">
            <h3>Add Allowed IP</h3>
            <form onsubmit="addIpSubmit(event)">
                <div class="input-group">
                    <label>IP Address</label>
                    <input type="text" id="newIp" required placeholder="1.2.3.4">
                </div>
                <div class="input-group">
                    <label>Label</label>
                    <input type="text" id="newIpLabel" required placeholder="Office VPN">
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn-secondary" onclick="closeModal('addIpModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Add IP</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-top: 0.5rem;"></p>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
                <button type="button" class="btn-primary" onclick="closeModal('alertModal')">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="confirmTitle">Confirm Action</h3>
            <p id="confirmMessage" style="margin-top: 0.5rem;"></p>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
                <button type="button" class="btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                <button type="button" class="btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    </main>
    </div>

    <!-- JS Logic -->
    <script src="/admin/js/app.js?v=5"></script>
    <script>
        // Simple router
        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.getElementById('view-' + tabId).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            // Invoke loaders from app.js
            if (tabId === 'keys') loadKeys();
            if (tabId === 'whitelist') loadWhitelist();
            if (tabId === 'users') loadUsers();
            if (tabId === 'providers') loadProviders();
        }

        async function checkAuth() {
            try {
                const res = await fetch('/api/admin/check-auth');
                if (!res.ok) throw new Error();
                const data = await res.json();
                document.getElementById('currentUser').textContent = data.username;
            } catch (e) {
                window.location.href = '/admin/';
            }
        }

        // Init
        checkAuth();
    </script>
</body>

</html>